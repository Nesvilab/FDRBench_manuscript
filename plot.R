library(tidyverse)
library(ggpubr)

plot_fdp_fdr=function(fdp_file="", # the FDP (in csv format) estimation file generated by FDRBench
                      fdr_max=NULL,
                      fig_title=NULL,
                      scale_xy=TRUE,
                      add_numbers=FALSE,
                      numbers_position=NULL,
                      numbers_font_size=11,
                      r=1,
                      fixed_fdr_max=FALSE,
                      max_x=NA,
                      max_y=NA,
                      color_mapping=NULL,
                      legend_position=c(0.7, 0.16),
                      legend_font_size=11,
                      fdr_decimal_place=2,
                      return_data=FALSE,
                      add_max_qvalue=FALSE) {
  if(is.null(color_mapping)){
    color_mapping <- c("Paired method" = "#7CAE00", "Sample method" = "#C77CFF", "Lower bound" = "#00BFC4", "Combined method" = "#F8766D")
  }
  x <- read_csv(fdp_file)
  if("paired_fdp" %in% names(x)){
    if(r>=2){
      dat <- x %>% select(q_value,combined_fdp,paired_fdp,lower_bound_fdp) %>% distinct() %>%
        rename(`Combined method`=combined_fdp,`Matched method`=paired_fdp,`Lower bound`=lower_bound_fdp) %>%
        gather(key = "Method",value = "FDP",-`q_value`) %>% select(q_value,FDP,Method)
      dat$Method <- factor(dat$Method, levels = c("Combined method","Matched method","Lower bound"))
    }else{
      dat <- x %>% select(q_value,combined_fdp,paired_fdp,lower_bound_fdp) %>% distinct() %>%
        rename(`Combined method`=combined_fdp,`Paired method`=paired_fdp,`Lower bound`=lower_bound_fdp) %>%
        gather(key = "Method",value = "FDP",-`q_value`) %>% select(q_value,FDP,Method)
      dat$Method <- factor(dat$Method, levels = c("Combined method","Paired method","Lower bound"))
    }
  }else{
    dat <- x %>% select(q_value,combined_fdp,lower_bound_fdp) %>% distinct() %>%
      rename(`Combined method`=combined_fdp,`Lower bound`=lower_bound_fdp) %>%
      gather(key = "Method",value = "FDP",-`q_value`) %>% select(q_value,FDP,Method)
    dat$Method <- factor(dat$Method, levels = c("Combined method","Lower bound"))
  }


  max_fdp <- max(c(dat$FDP,dat$q_value))
  if(!is.null(fdr_max)){
    if(fixed_fdr_max){
      max_fdp <- fdr_max
    }else{
      max_fdp <- min(c(fdr_max,max_fdp))
    }
  }

  gg1 <- ggplot(dat,aes(x=q_value,y=FDP,color=Method)) +
    geom_abline(slope = 1,intercept = 0,color="gray")+
    geom_line()+
    xlab("FDR threshold")+
    ylab("Estimated FDP")+
    theme_bw()+
    theme_pubr(base_size = 12,border = TRUE)

  if(!is.null(color_mapping)){
    gg1 <- gg1 + scale_color_manual(values = color_mapping)
  }

  if(scale_xy){

    if(!is.na(max_x) || !is.na(max_y)){
      gg1 <- gg1 + geom_vline(xintercept = 0.01,linetype=2,color="blue")
      if(!is.na(max_x)){
        gg1 <- gg1 + xlim(0,max_x) + scale_x_continuous(labels = scales::percent,limits =c(0,max_x))
      }else{
        gg1 <- gg1 + xlim(0,max_fdp)+ scale_x_continuous(labels = scales::percent,limits =c(0,max_fdp))
      }
      if(!is.na(max_y)){
        gg1 <- gg1 + ylim(0,max_y) + scale_y_continuous(labels = scales::percent,limits =c(0,max_y))
      }else{
        gg1 <- gg1 + ylim(0,max_fdp) + scale_y_continuous(labels = scales::percent,limits =c(0,max_fdp))
      }
    }else{
      gg1 <- gg1 + geom_vline(xintercept = 0.01,linetype=2,color="blue")+
        xlim(0,max_fdp)+
        ylim(0,max_fdp)+
        scale_y_continuous(labels = scales::percent,limits =c(0,max_fdp))+
        scale_x_continuous(labels = scales::percent,limits =c(0,max_fdp))
    }
  }

  gg1 <- gg1 + theme(#legend.position="inside",
    legend.position = legend_position,
    legend.background = element_blank(),
    legend.text=element_text(size=legend_font_size),
    legend.title=element_text(size=legend_font_size),
    plot.margin = unit(2*c(0.1, 0.1, 0.1, 0.1),"inches"),
    axis.text.y = element_text(angle = 90, hjust = 0.5))


  if(!is.null(fig_title)){
    gg1 <- gg1 + ggtitle(fig_title)
  }

  added_numbers <- NULL
  if(add_numbers){
    if(fdr_decimal_place==1){
      y <- dat %>% filter(q_value<=0.01) %>% group_by(Method) %>% arrange(desc(q_value)) %>% filter(row_number()==1) %>% summarise(FDP001=max(FDP)) %>% mutate(ratio=sprintf("%.1f%%",FDP001*100))
    }else if(fdr_decimal_place==2){
      y <- dat %>% filter(q_value<=0.01) %>% group_by(Method) %>% arrange(desc(q_value)) %>% filter(row_number()==1) %>% summarise(FDP001=max(FDP)) %>% mutate(ratio=sprintf("%.2f%%",FDP001*100))
    }else{
      y <- dat %>% filter(q_value<=0.01) %>% group_by(Method) %>% arrange(desc(q_value)) %>% filter(row_number()==1) %>% summarise(FDP001=max(FDP)) %>% mutate(ratio=sprintf("%.4f%%",FDP001*100))
    }
    if(abs(max_fdp-0.01)<=0.02){
      added_numbers <- paste("Total discoveries:",nrow(x %>% filter(q_value<=0.01)),"\n",paste(y$Method,y$ratio,sep=":",collapse = "\n"),sep="")
      if(add_max_qvalue){
        added_numbers <- paste(added_numbers,"\n","Max q-value:",sprintf("%.2e",max(x$q_value)),sep="")
      }
      if(is.null(numbers_position)){
        gg1 <- gg1 + annotate("text", x = max_fdp*0.1, y = 0.9*max_fdp, label = added_numbers, color = "black", size = numbers_font_size/.pt,hjust = 0)
      }else{
        gg1 <- gg1 + annotate("text", x = numbers_position[1], y = numbers_position[2], label = added_numbers, color = "black", size = numbers_font_size/.pt,hjust = 0)
      }

    }else{
      added_numbers <- paste("Total discoveries:",nrow(x %>% filter(q_value<=0.01)),"\n",paste(y$Method,y$ratio,sep=":",collapse = "\n"),sep="")
      if(add_max_qvalue){
        added_numbers <- paste(added_numbers,"\n","Max q-value:",sprintf("%.2e",max(x$q_value)),sep="")
      }
      if(is.null(numbers_position)){
        gg1 <- gg1 + annotate("text", x = 0.01*1.05, y = 0.9*max_fdp, label = added_numbers, color = "black", size = numbers_font_size/.pt,hjust = 0)
      }else{
        gg1 <- gg1 + annotate("text", x = numbers_position[1], y = numbers_position[2], label = added_numbers, color = "black", size = numbers_font_size/.pt,hjust = 0)
      }
    }
  }


  if(return_data){
    return(list(gg=gg1,data=dat,added_numbers=added_numbers))
  }else{
    return(gg1)
  }

}

base_dir <- "G:\\dev\\FDRBench\\PXD041421_timsTOF_Human\\FDRBench_peptide\\"
setwd(base_dir)

## load the above R function first before running the following R code.
fdp_plot <- plot_fdp_fdr("fragpipe-percolator_fdp_peptide.csv",fdr_max = 0.1,add_numbers = TRUE, fixed_fdr_max=TRUE)
pdf("fdr-fdp.pdf",width = 4.5,height = 4.5)
print(fdp_plot)
dev.off()

print(fdp_plot)